---
import { CONTACT_CTA } from '../config/site';
import { NAV_LINKS } from '../data/navigation';
import { PERSON } from '../config/person';
import Icon from './Icon.astro';

interface Props {
  lang?: 'es' | 'en';
}

const lang = Astro.props.lang ?? 'es';
const links = NAV_LINKS[lang];
const homeHref = lang === 'es' ? '/es' : '/en';
const contactCta = CONTACT_CTA.primary.label;
const homeLabel = lang === 'es' ? 'Volver al inicio' : 'Back to home';
const navLabel = lang === 'es' ? 'Navegaci칩n principal' : 'Primary navigation';
const mobileLabel = lang === 'es' ? 'Men칰 m칩vil' : 'Mobile menu';
const themeLabel = lang === 'es' ? 'Cambiar tema' : 'Toggle theme';
const currentPath = Astro.url.pathname;

const isActive = (href: string) => currentPath === href || (href !== '/' && currentPath.startsWith(href));

const langOptions = [
  { code: 'es', label: 'ES', href: '/es', flag: '游쀯릖' },
  { code: 'en', label: 'EN', href: '/en', flag: '游쥟릖' }
];
---

<header class="sticky top-0 z-50 border-b border-border/50 bg-surface/85 backdrop-blur">
  <div class="page-width flex items-center justify-between gap-3 px-4 py-3 md:px-0">
    <a
      class="group flex items-center gap-3 rounded-full border border-border/60 bg-panel px-3 py-2 shadow-soft transition hover:border-accent focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent"
      href={homeHref}
      aria-label={homeLabel}
    >
      <span class="relative grid h-10 w-10 place-items-center rounded-full bg-panel/80 p-1 shadow-soft transition group-hover:scale-[1.03]">
        <img
          src="/images/logo-128.png"
          alt={`${PERSON.shortName} logo`}
          width="128"
          height="128"
          class="h-full w-full rounded-full object-contain"
          loading="eager"
          decoding="async"
        />
      </span>
      <span class="hidden flex-col text-left leading-tight sm:inline-flex">
        <span class="block text-sm font-semibold text-foreground">{PERSON.shortName}</span>
      </span>
    </a>

    <nav class="hidden items-center gap-4 text-sm font-semibold lg:flex" aria-label={navLabel}>
      {links.map((item) => {
        const active = isActive(item.href);
        return (
          <a
            class={`inline-flex items-center px-1 py-1 transition decoration-transparent ${active ? 'text-foreground border-b-2 border-accent' : 'text-foreground/70 hover:text-foreground'} focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent`}
            href={item.href}
            aria-current={active ? 'page' : undefined}
          >
            {item.label}
          </a>
        );
      })}
    </nav>

    <div class="hidden items-center gap-3 lg:flex">
      <button
        type="button"
        class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-border/70 bg-panel text-foreground shadow-soft transition hover:border-accent hover:-rotate-6 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent"
        data-theme-toggle
        aria-label={themeLabel}
        aria-pressed="false"
      >
        <span class="theme-icon-sun" aria-hidden="true">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="4" stroke-width="1.6" />
            <path stroke-width="1.6" stroke-linecap="round" d="M12 3v2m0 14v2m9-9h-2M5 12H3m14.5-7.5-1.4 1.4M7.9 16.1 6.5 17.5m0-12 1.4 1.4m9.2 9.2 1.4 1.4" />
          </svg>
        </span>
        <span class="theme-icon-moon hidden" aria-hidden="true">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79Z" />
          </svg>
        </span>
      </button>
      <details class="relative">
        <summary class="inline-flex cursor-pointer items-center gap-2 rounded-full border border-border/70 bg-panel px-2 py-1.5 text-sm font-semibold text-foreground transition hover:border-accent focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent">
          <span aria-hidden="true" class="text-lg leading-none">{lang === 'es' ? '游쀯릖' : '游쥟릖'}</span>
          <span class="sr-only">{lang === 'es' ? 'Espa침ol' : 'English'}</span>
        </summary>
        <div class="absolute right-0 mt-2 w-24 rounded-md border border-border/70 bg-panel shadow-soft">
          {langOptions.map((option) => (
            <a
              class="flex items-center gap-2 px-3 py-2 text-sm font-semibold text-foreground/85 transition decoration-transparent hover:text-foreground focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent"
              href={option.href}
              hreflang={option.code}
            >
              <span aria-hidden="true" class="text-lg leading-none">{option.flag}</span>
              <span class="sr-only">{option.label}</span>
            </a>
          ))}
        </div>
      </details>
      <a
        class="inline-flex items-center justify-center gap-2 rounded-full bg-accent px-4 py-2 text-sm font-semibold text-surface shadow-soft transition hover:bg-accent-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-surface"
        href={CONTACT_CTA.primary.href}
      >
        <Icon name="whatsapp" label="WhatsApp" />
        {contactCta}
      </a>
    </div>

    <div class="flex items-center gap-2 lg:hidden">
      <button
        type="button"
        class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-border/70 bg-panel text-foreground transition hover:border-accent focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent"
        data-theme-toggle
        aria-label={themeLabel}
        aria-pressed="false"
      >
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364-6.364-1.414 1.414M7.05 16.95l-1.414 1.414m0-12.728L7.05 7.05m9.9 9.9 1.414 1.414" />
          <circle cx="12" cy="12" r="4" stroke-width="1.5" />
        </svg>
      </button>
      <button
        type="button"
        class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-border/70 bg-panel text-foreground transition hover:border-accent focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent"
        aria-expanded="false"
        aria-controls="mobile-nav"
        data-nav-toggle
      >
        <span class="sr-only">Toggle navigation</span>
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
  </div>

  <div id="mobile-nav" class="hidden border-t border-border/60 bg-surface/98 backdrop-blur-lg lg:hidden" aria-label={mobileLabel}>
    <div class="page-width flex flex-col gap-3 px-4 py-4 text-sm">
      <div class="flex items-center gap-3 border border-border/60 bg-panel px-3 py-2">
        <img
          src="/images/person-128.png"
          alt={`${PERSON.shortName}`}
          width="128"
          height="128"
          class="h-10 w-10 rounded-full object-cover shadow-soft"
          loading="lazy"
          decoding="async"
        />
        <div class="leading-tight">
          <p class="text-sm font-semibold text-foreground">{PERSON.shortName}</p>
        </div>
      </div>
      {links.map((item) => (
        <a
          class="border border-border/60 bg-panel px-3 py-2 text-foreground/90 transition decoration-transparent hover:border-accent hover:text-foreground focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent"
          href={item.href}
        >
          {item.label}
        </a>
      ))}
      <details class="border border-border/70 bg-panel px-3 py-2">
        <summary class="flex cursor-pointer items-center justify-between text-sm font-semibold text-foreground">
          <span aria-hidden="true" class="text-lg leading-none">{lang === 'es' ? '游쀯릖' : '游쥟릖'}</span>
          <svg class="h-4 w-4" viewBox="0 0 16 16" fill="none" stroke="currentColor"><path d="M4 6l4 4 4-4" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" /></svg>
          <span class="sr-only">{lang === 'es' ? 'Idioma actual Espa침ol' : 'Current language English'}</span>
        </summary>
        <div class="mt-2 space-y-1">
          {langOptions.map((option) => (
            <a
              class="flex items-center gap-2 rounded-md px-3 py-2 text-foreground/85 transition decoration-transparent hover:text-foreground focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent"
              href={option.href}
              hreflang={option.code}
            >
              <span aria-hidden="true" class="text-lg leading-none">{option.flag}</span>
              <span class="sr-only">{option.label}</span>
            </a>
          ))}
        </div>
      </details>
      <a
        class="inline-flex items-center justify-center rounded-full bg-accent px-4 py-2 text-sm font-semibold text-surface shadow-soft transition hover:bg-accent-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-surface"
        href={CONTACT_CTA.primary.href}
      >
        {contactCta}
      </a>
    </div>
  </div>

  <script>
    const navToggle = document.querySelector('[data-nav-toggle]');
    const mobileNav = document.getElementById('mobile-nav');
    const toggles = Array.from(document.querySelectorAll('[data-theme-toggle]'));
    const icons = {
      sun: Array.from(document.querySelectorAll('.theme-icon-sun')),
      moon: Array.from(document.querySelectorAll('.theme-icon-moon'))
    };
    const root = document.documentElement;
    const storageKey = 'theme-preference';

    const getPreferredTheme = () => {
      const stored = localStorage.getItem(storageKey);
      if (stored === 'light' || stored === 'dark') return stored;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };

    const setTheme = (mode) => {
      const isDark = mode === 'dark';
      root.classList.toggle('theme-dark', isDark);
      root.classList.toggle('theme-light', !isDark);
      toggles.forEach((btn) => btn.setAttribute('aria-pressed', String(isDark)));
      icons.sun.forEach((el) => el.classList.toggle('hidden', isDark));
      icons.moon.forEach((el) => el.classList.toggle('hidden', !isDark));
      localStorage.setItem(storageKey, mode);
    };

    setTheme(getPreferredTheme());

    toggles.forEach((btn) => {
      btn.addEventListener('click', () => {
        const next = root.classList.contains('theme-dark') ? 'light' : 'dark';
        setTheme(next);
      });
    });

    if (navToggle instanceof HTMLElement && mobileNav) {
      const toggleMenu = () => {
        const isOpen = mobileNav.classList.toggle('hidden');
        navToggle.setAttribute('aria-expanded', String(!isOpen));
      };

      navToggle.addEventListener('click', toggleMenu);

      mobileNav.querySelectorAll('a').forEach((link) => {
        link.addEventListener('click', () => {
          if (!mobileNav.classList.contains('hidden')) toggleMenu();
        });
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !mobileNav.classList.contains('hidden')) {
          toggleMenu();
          navToggle.focus();
        }
      });
    }
  </script>
</header>
